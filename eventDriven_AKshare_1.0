"""
AI è´¢ç»æ–°é—»æ¦‚å¿µæŒ–æ˜ç»ˆç«¯
åŠŸèƒ½ï¼šå®æ—¶è·å–è´¢ç»æ–°é—»ï¼Œä½¿ç”¨ GLM-4-Flash è¿›è¡Œæ¦‚å¿µè¯†åˆ«å’Œä¸ªè‚¡æŒ–æ˜
"""

import os
import streamlit as st
from langchain_openai import ChatOpenAI
from langchain.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
import akshare as ak


# ================= é…ç½®éƒ¨åˆ† =================

st.set_page_config(
    page_title="AI è´¢ç»æ–°é—»æ¦‚å¿µæŒ–æ˜ç»ˆç«¯",
    page_icon="ğŸ“°",
    layout="wide"
)


# ================= æ•°æ®è·å–å±‚ =================

@st.cache_data(ttl=300)  # ç¼“å­˜5åˆ†é’Ÿï¼Œé¿å…é¢‘ç¹è¯·æ±‚
def get_news_data():
    """
    è·å–å®æ—¶è´¢ç»æ–°é—»æ•°æ®
    Returns:
        DataFrame: åŒ…å«æ ‡é¢˜ã€æ—¥æœŸã€æ—¶é—´å’Œå†…å®¹çš„æ–°é—»æ•°æ®
    """
    try:
        df = ak.stock_info_global_cls()
        return df
    except Exception as e:
        st.error(f"è·å–æ–°é—»æ•°æ®å¤±è´¥: {e}")
        return None


# ================= AI åˆ†æå±‚ =================

def analyze_news(title: str, content: str, api_key: str) -> str:
    """
    ä½¿ç”¨ GLM-4-Flash åˆ†ææ–°é—»ï¼Œæå–æ¦‚å¿µå’Œä¸ªè‚¡
    
    Args:
        title: æ–°é—»æ ‡é¢˜
        content: æ–°é—»å†…å®¹
        api_key: GLM API Key
    
    Returns:
        str: AI åˆ†æç»“æœï¼ˆMarkdown æ ¼å¼ï¼‰
    """
    try:
        # åˆå§‹åŒ– LLM
        llm = ChatOpenAI(
            api_key=api_key,
            base_url="https://open.bigmodel.cn/api/paas/v4/",  # ä¿®å¤ï¼šç§»é™¤æœ«å°¾ç©ºæ ¼
            model="glm-4-flash",
            temperature=0.3  # é™ä½æ¸©åº¦ä»¥è·å¾—æ›´ç²¾ç¡®çš„åˆ†æ
        )
        
        # æ„å»º Prompt
        prompt = ChatPromptTemplate.from_messages([
            ("system", """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„è´¢ç»è¯åˆ¸åˆ†æå¸ˆã€‚è¯·é˜…è¯»ç”¨æˆ·æä¾›çš„è´¢ç»æ–°é—»ï¼Œå®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š

1. **æ¦‚å¿µè¯†åˆ«**ï¼šåˆ†æè¯¥æ–°é—»æ¶‰åŠçš„æ ¸å¿ƒäº§ä¸šé“¾æ¦‚å¿µï¼ˆä¾‹å¦‚ï¼šRobotaxi, CPO, åˆ›æ–°è¯ç­‰ï¼‰ã€‚
2. **ä¸ªè‚¡æŒ–æ˜**ï¼šæ ¹æ®æ¦‚å¿µï¼Œåˆ—å‡º3-5åªAè‚¡æˆ–æ¸¯è‚¡ä¸­æœ€ç›¸å…³çš„é¾™å¤´ä¸ªè‚¡åç§°ï¼Œå¹¶ç”¨ä¸€å¥è¯è§£é‡Šå…³è”ç†ç”±ã€‚

è¾“å‡ºæ ¼å¼è¯·ä½¿ç”¨ Markdownï¼Œæ¸…æ™°åˆ†çº§ã€‚"""),
            ("user", """æ–°é—»æ ‡é¢˜ï¼š{title}

æ–°é—»å†…å®¹ï¼š{content}

è¯·å¼€å§‹åˆ†æã€‚""")
        ])
        
        # æ„å»ºæ‰§è¡Œé“¾å¹¶è°ƒç”¨
        chain = prompt | llm | StrOutputParser()
        result = chain.invoke({
            "title": title,
            "content": content
        })
        
        return result
        
    except Exception as e:
        raise RuntimeError(f"AI åˆ†æå¤±è´¥: {e}")


# ================= ç•Œé¢å±‚ =================

def render_sidebar():
    """æ¸²æŸ“ä¾§è¾¹æ ï¼šAPI Key é…ç½®"""
    with st.sidebar:
        st.header("âš™ï¸ é…ç½®")
        
        # API Key è¾“å…¥ï¼ˆä½¿ç”¨å¯†ç è¾“å…¥æ¡†ä¿æŠ¤ï¼‰
        api_key = st.text_input(
            "GLM API Key",
            value=os.getenv("GLM_API_KEY", ""),  # ä¼˜å…ˆä»ç¯å¢ƒå˜é‡è¯»å–
            type="password",
            help="è¯·è¾“å…¥æ‚¨çš„æ™ºè°± GLM API Key",
            placeholder="sk-xxxxxxxx"
        )
        
        st.divider()
        st.markdown("""
        **ä½¿ç”¨è¯´æ˜ï¼š**
        1. åœ¨å·¦ä¾§è¾“å…¥ GLM API Key
        2. ç‚¹å‡»æ–°é—»æ ‡é¢˜æŸ¥çœ‹è¯¦æƒ…
        3. ç‚¹å‡»"å¼€å§‹åˆ†æ"è·å– AI è§£è¯»
        
        **æ•°æ®æ¥æºï¼š** æ–°æµªè´¢ç»
        **æ¨¡å‹ï¼š** GLM-4-Flash
        """)
        
        return api_key


def render_news_list(news_df, selected_idx: int):
    """æ¸²æŸ“å·¦ä¾§æ–°é—»åˆ—è¡¨"""
    st.subheader("ğŸ“° å®æ—¶æ–°é—»æµ")
    
    for idx, row in news_df.iterrows():
        with st.container():
            # é«˜äº®é€‰ä¸­é¡¹
            is_selected = idx == selected_idx
            border_color = "#2563eb" if is_selected else "#e2e8f0"
            
            # æ–°é—»å¡ç‰‡æŒ‰é’®
            button_label = f"**{row['æ ‡é¢˜']}**\n\n`{row['å‘å¸ƒæ—¥æœŸ']} {row['å‘å¸ƒæ—¶é—´']}`"
            
            if st.button(
                button_label,
                key=f"news_{idx}",
                use_container_width=True,
                help="ç‚¹å‡»æŸ¥çœ‹åˆ†æ"
            ):
                st.session_state.selected_idx = idx
                st.rerun()
            
            # åˆ†éš”çº¿
            st.markdown(
                f"<div style='border-bottom: 2px solid {border_color}; margin-bottom: 10px;'></div>",
                unsafe_allow_html=True
            )


def render_news_detail(current_news, api_key: str):
    """æ¸²æŸ“å³ä¾§æ–°é—»è¯¦æƒ…å’Œ AI åˆ†æ"""
    st.markdown("---")
    
    # 1. å±•ç¤ºæ–°é—»åŸæ–‡
    st.subheader(f"ğŸ“Œ {current_news['æ ‡é¢˜']}")
    st.caption(f"å‘å¸ƒæ—¶é—´ï¼š{current_news['å‘å¸ƒæ—¥æœŸ']} {current_news['å‘å¸ƒæ—¶é—´']}")
    st.info(current_news['å†…å®¹'])
    
    # 2. AI åˆ†æåŒºåŸŸ
    st.markdown("### ğŸ§  AI æ·±åº¦åˆ†æ")
    
    # æ£€æŸ¥ API Key
    if not api_key or api_key == "XXXXXX":
        st.warning("âš ï¸ è¯·å…ˆé…ç½®æœ‰æ•ˆçš„ GLM API Key")
        return
    
    if st.button(
        "âœ¨ å¼€å§‹åˆ†æï¼šæå–æ¦‚å¿µ & æŒ–æ˜ä¸ªè‚¡",
        type="primary",
        use_container_width=True
    ):
        with st.spinner("GLM-4-Flash æ­£åœ¨é˜…è¯»æ–°é—»å¹¶è¿›è¡Œé€»è¾‘æ¨ç†..."):
            try:
                result = analyze_news(
                    title=current_news['æ ‡é¢˜'],
                    content=current_news['å†…å®¹'],
                    api_key=api_key
                )
                
                # å±•ç¤ºç»“æœ
                st.success("âœ… åˆ†æå®Œæˆï¼")
                st.markdown(result)
                
                # åŸå§‹è¾“å‡ºï¼ˆå¯æŠ˜å ï¼‰
                with st.expander("ğŸ”§ æŸ¥çœ‹åŸå§‹è¾“å‡º"):
                    st.code(result, language="markdown")
                    
            except Exception as e:
                st.error(f"âŒ åˆ†æè¿‡ç¨‹å‡ºé”™: {e}")
                st.info("è¯·æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®ï¼Œæˆ–ç¨åé‡è¯•ã€‚")


# ================= ä¸»ç¨‹åº =================

def main():
    """ä¸»åº”ç”¨å…¥å£"""
    
    # é¡µé¢æ ‡é¢˜
    st.title("ğŸ¤– AI æ–°é—»æ¦‚å¿µä¸ä¸ªè‚¡æŒ–æ˜")
    
    # æ¸²æŸ“ä¾§è¾¹æ ï¼Œè·å– API Key
    api_key = render_sidebar()
    
    # åŠ è½½æ•°æ®
    with st.spinner("æ­£åœ¨åŠ è½½æ–°é—»æ•°æ®..."):
        news_df = get_news_data()
    
    if news_df is None or news_df.empty:
        st.error("æ— æ³•è·å–æ–°é—»æ•°æ®ï¼Œè¯·ç¨åé‡è¯•ã€‚")
        return
    
    # åˆå§‹åŒ– Session State
    if 'selected_idx' not in st.session_state:
        st.session_state.selected_idx = 0
    
    # ç¡®ä¿ç´¢å¼•æœ‰æ•ˆ
    if st.session_state.selected_idx >= len(news_df):
        st.session_state.selected_idx = 0
    
    # å¸ƒå±€ï¼šå·¦ä¾§æ–°é—»åˆ—è¡¨ï¼Œå³ä¾§è¯¦æƒ…ä¸åˆ†æ
    col_list, col_detail = st.columns([3, 7])
    
    with col_list:
        render_news_list(news_df, st.session_state.selected_idx)
    
    with col_detail:
        current_news = news_df.iloc[st.session_state.selected_idx]
        render_news_detail(current_news, api_key)


if __name__ == "__main__":
    main()
